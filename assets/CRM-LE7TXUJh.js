import{j as e,a as b,e as u}from"./index-i57Nd5YW.js";import{b as c}from"./vendor-DPLMwiL-.js";const T=()=>{const[f,N]=c.useState(!1),[P,S]=c.useState(!0),[j,g]=c.useState([]),[v,h]=c.useState(!1),[y,w]=c.useState(!1),[p,x]=c.useState(null),[E,d]=c.useState(!1),[C,m]=c.useState({type:"",text:""}),[t,i]=c.useState({companyName:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",clientType:"",notes:"",password:"",role:"user"});c.useEffect(()=>{(()=>{const a=b.isAuthenticated();N(a),S(!1)})()},[]),c.useEffect(()=>{f&&(async()=>{try{const a=await u.getAll(),n=Array.isArray(a)?a:a.customers||[];g(n)}catch(a){console.error("Error loading customers:",a),g([])}})()},[f]);const $=async s=>{if(s&&s.preventDefault&&s.preventDefault(),m({type:"",text:""}),d(!0),!t.firstName.trim()){m({type:"error",text:"Please enter a first name."}),d(!1);return}if(!t.lastName.trim()){m({type:"error",text:"Please enter a last name."}),d(!1);return}if(!t.email.trim()){m({type:"error",text:"Please enter an email address."}),d(!1);return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email.trim())){m({type:"error",text:"Please enter a valid email address."}),d(!1);return}if(!t.password||t.password.length<8){m({type:"error",text:"Please enter a password (min 8 characters)."}),d(!1);return}const n={firstName:t.firstName.trim(),lastName:t.lastName.trim(),email:t.email.trim(),phone:(t.phone||"").trim()||null,company:(t.companyName||"").trim()||null,address:`${t.address}, ${t.city}, ${t.state} ${t.zipCode}`.trim().replace(/^,\s*|,\s*$/g,"")||null,password:t.password};try{const r=await u.create(n);i({companyName:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",projectType:"",notes:"",password:""}),h(!1);const l=await u.getAll(),o=Array.isArray(l)?l:l.customers||[];g(o),m({type:"success",text:"Customer added successfully!"}),d(!1)}catch(r){let l="Failed to add customer. ";r.message.includes("Validation failed")?l+="Please check all required fields are filled correctly. Make sure you have entered both first and last name, a valid email address, and a password.":r.message.includes("already exists")?l+="A customer with this email already exists.":l+=`Error: ${r.message}`,m({type:"error",text:l}),d(!1)}},L=async s=>{if(s.preventDefault(),console.log("Attempting to update customer with data:",t),!t.firstName.trim()){alert("Please enter a first name.");return}if(!t.lastName.trim()){alert("Please enter a last name.");return}if(!t.email.trim()){alert("Please enter an email address.");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email.trim())){alert("Please enter a valid email address.");return}const n={firstName:t.firstName.trim(),lastName:t.lastName.trim(),email:t.email.trim(),phone:t.phone.trim()||null,company:t.companyName.trim()||null,address:`${t.address}, ${t.city}, ${t.state} ${t.zipCode}`.trim().replace(/^,\s*|,\s*$/g,"")||null,role:t.role,clientType:t.clientType,notes:t.notes};t.password&&t.password.length>=8&&(n.password=t.password);try{console.log("Sending updated customer data to backend:",n),await u.update(p,n),i({companyName:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",clientType:"",notes:""}),x(null),h(!1);const r=await u.getAll(),l=Array.isArray(r)?r:r.customers||[];g(l),alert("Customer updated successfully!")}catch(r){console.error("Error updating customer:",r),console.error("Error details:",r.data);let l="Failed to update customer. ";if(r.message.includes("Authentication required")){l+="Please log in again.",window.location.href="/login";return}else if(r.message.includes("Session expired")){l+="Your session has expired. Please log in again.",window.location.href="/login";return}else l+=`Error: ${r.message}`,r.data&&r.data.error&&r.data.error.details&&(l+=`

Validation errors:`,r.data.error.details.forEach(o=>{l+=`
- ${o.path||o.param}: ${o.msg}`}));alert(l)}},k=s=>{console.log("Editing customer:",s);let a="",n="",r="",l="";if(s.address){const o=s.address.split(", ");if(o.length>=1&&(a=o[0]||""),o.length>=2&&(n=o[1]||""),o.length>=3){const A=o[2].split(" ");r=A[0]||"",l=A[1]||""}}i({companyName:s.company||"",firstName:s.firstName||"",lastName:s.lastName||"",email:s.email||"",phone:s.phone||"",address:a,city:n,state:r,zipCode:l,clientType:s.clientType||"",notes:s.notes||"",role:s.role||"user"}),x(s.id),h(!0)},R=async s=>{if(window.confirm("Are you sure you want to delete this customer?"))try{await u.delete(s);const a=await u.getAll(),n=Array.isArray(a)?a:a.customers||[];g(n),alert("Customer deleted successfully!")}catch(a){console.error("Error deleting customer:",a);let n="Failed to delete customer. ";if(a.message.includes("Authentication required")){n+="Please log in again.",window.location.href="/login";return}else if(a.message.includes("Session expired")){n+="Your session has expired. Please log in again.",window.location.href="/login";return}else n+=`Error: ${a.message}`;alert(n)}};return P?e.jsx("div",{className:"crm-container",style:{minHeight:"60vh",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("h2",{children:"Loading CRM..."})}):f?e.jsxs("div",{className:"crm-container",children:[e.jsxs("div",{className:"crm-header",children:[e.jsx("h1",{className:"crm-title",children:"Customer Relationship Management"}),e.jsx("button",{className:"crm-logout-btn",onClick:()=>{b.logout(),N(!1),window.location.href="/"},children:"Logout"})]}),e.jsxs("div",{className:"crm-dashboard",children:[e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Customer Database"}),e.jsx("p",{children:"View and manage customer information, contact details, and project history."}),e.jsx("button",{className:"crm-btn-main",onClick:()=>{w(!y),h(!1),x(null)},children:y?"Hide Customers":"View Customers"}),e.jsx("button",{className:"crm-btn-secondary",onClick:()=>{h(!0),w(!1),x(null),i({companyName:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",projectType:"",notes:""})},children:"Add Customer"})]}),e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Active Projects"}),e.jsxs("ul",{style:{listStyle:"none",padding:0},children:[e.jsx("li",{children:"Office Building Wiring - 75% Complete"}),e.jsx("li",{children:"Factory Automation - 40% Complete"}),e.jsx("li",{children:"Warehouse Network - Planning Phase"})]})]}),e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Recent Activity"}),e.jsxs("ul",{style:{listStyle:"none",padding:0},children:[e.jsx("li",{children:"New quote sent to ABC Corp"}),e.jsx("li",{children:"Project milestone reached"}),e.jsx("li",{children:"Customer feedback received"})]})]})]}),(v||y)&&e.jsxs("div",{className:"crm-section",children:[e.jsx("h2",{style:{color:"#22314a",marginBottom:"1.5rem"},children:"ðŸ‘¥ Customer Management"}),v&&e.jsxs("div",{className:"crm-form",children:[e.jsx("h3",{style:{color:"#22314a",marginBottom:"1rem"},children:p?"Edit Customer":"Add New Customer"}),e.jsxs("form",{onSubmit:p?L:$,noValidate:!0,children:[e.jsx("input",{type:"text",placeholder:"Company Name",value:t.companyName,onChange:s=>i({...t,companyName:s.target.value})}),e.jsx("input",{type:"text",placeholder:"First Name",value:t.firstName,onChange:s=>i({...t,firstName:s.target.value}),required:!0}),e.jsx("input",{type:"text",placeholder:"Last Name",value:t.lastName,onChange:s=>i({...t,lastName:s.target.value}),required:!0}),e.jsx("input",{type:"email",placeholder:"Email Address",value:t.email,onChange:s=>i({...t,email:s.target.value}),required:!0}),p&&e.jsxs("select",{value:t.role,onChange:s=>i({...t,role:s.target.value}),children:[e.jsx("option",{value:"user",children:"User"}),e.jsx("option",{value:"admin",children:"Admin"})]}),e.jsx("input",{type:"password",placeholder:p?"Set/Change Password (min 8 chars, optional)":"Password (min 8 chars)",value:t.password,onChange:s=>i({...t,password:s.target.value})}),e.jsx("input",{type:"tel",placeholder:"Phone Number",value:t.phone,onChange:s=>i({...t,phone:s.target.value})}),e.jsx("input",{type:"text",placeholder:"Street Address",value:t.address,onChange:s=>i({...t,address:s.target.value})}),e.jsx("input",{type:"text",placeholder:"City",value:t.city,onChange:s=>i({...t,city:s.target.value})}),e.jsx("input",{type:"text",placeholder:"State",value:t.state,onChange:s=>i({...t,state:s.target.value})}),e.jsx("input",{type:"text",placeholder:"ZIP Code",value:t.zipCode,onChange:s=>i({...t,zipCode:s.target.value})}),e.jsxs("select",{value:t.clientType,onChange:s=>i({...t,clientType:s.target.value}),children:[e.jsx("option",{value:"",children:"Select Client Type"}),e.jsx("option",{value:"Commercial",children:"Commercial"}),e.jsx("option",{value:"High End",children:"High End"}),e.jsx("option",{value:"Low End",children:"Low End"}),e.jsx("option",{value:"Residential",children:"Residential"}),e.jsx("option",{value:"Prospective",children:"Prospective"})]}),e.jsx("textarea",{placeholder:"Notes (optional)",value:t.notes,onChange:s=>i({...t,notes:s.target.value})}),C.text&&e.jsx("div",{className:`crm-feedback ${C.type}`,children:C.text}),e.jsxs("div",{className:"crm-form-actions",children:[e.jsx("button",{className:"crm-btn-main",type:"submit",disabled:E,children:p?"Update Customer":"Add Customer"}),e.jsx("button",{className:"crm-btn-secondary",type:"button",onClick:()=>{h(!1),x(null)},children:"Cancel"})]})]})]}),y&&e.jsxs("div",{children:[e.jsxs("h3",{style:{color:"#22314a",marginBottom:"1rem"},children:["Customer Database (",j.length," customers)"]}),e.jsx("div",{className:"crm-customer-list",children:j.length===0?e.jsx("div",{className:"crm-card",style:{textAlign:"center",color:"#666"},children:e.jsx("p",{children:'No customers added yet. Click "Add Customer" to get started.'})}):j.map(s=>e.jsxs("div",{className:"crm-customer-card",children:[e.jsxs("h4",{children:[s.firstName," ",s.lastName]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Company:"})," ",s.company]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",e.jsx("a",{href:`mailto:${s.email}`,style:{color:"#007bff",textDecoration:"none",marginLeft:"0.5rem"},children:s.email})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Phone:"})," ",e.jsx("a",{href:`tel:${s.phone}`,style:{color:"#007bff",textDecoration:"none",marginLeft:"0.5rem"},children:s.phone})]}),s.address&&e.jsxs("div",{children:[e.jsx("strong",{children:"Address:"})," ",s.address]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#666",marginTop:"1rem"},children:["Added: ",new Date(s.createdAt).toLocaleDateString()]}),e.jsxs("div",{className:"crm-customer-actions",children:[e.jsx("button",{className:"crm-btn-edit",onClick:()=>k(s),children:"Edit"}),e.jsx("button",{className:"crm-btn-delete",onClick:()=>R(s.id),children:"Delete"})]})]},s.id))})]})]})]}):e.jsx("div",{className:"crm-container",children:e.jsxs("div",{className:"crm-card",style:{maxWidth:500,margin:"3rem auto",textAlign:"center"},children:[e.jsx("h1",{className:"crm-title",children:"ðŸ”’ CRM Access Required"}),e.jsx("p",{style:{color:"#666",marginBottom:24},children:"Please log in to access the CRM system."}),e.jsx("a",{href:"/login",className:"crm-btn-main",children:"Go to Login Page"})]})})};export{T as default};
