import{j as e,a as N,e as u}from"./index-Bl6mqZnr.js";import{b as c}from"./vendor-Dd4J3GVN.js";const T=()=>{const[y,v]=c.useState(!1),[P,S]=c.useState(!0),[j,g]=c.useState([]),[w,h]=c.useState(!1),[f,A]=c.useState(!1),[p,x]=c.useState(null),[E,d]=c.useState(!1),[C,m]=c.useState({type:"",text:""}),[s,i]=c.useState({companyName:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",clientType:"",notes:"",password:"",role:"user"});c.useEffect(()=>{(()=>{const a=N.isAuthenticated();v(a),S(!1)})()},[]),c.useEffect(()=>{y&&(async()=>{try{console.log("ðŸ” Loading customers from API...");const a=await u.getAll();console.log("ðŸ“¦ API Response:",a);const l=Array.isArray(a)?a:a.customers||[];console.log("ðŸ‘¥ Customer list:",l),console.log("ðŸ“Š Number of customers:",l.length),g(l),l.length===0&&console.warn("âš ï¸ No customers found in response")}catch(a){if(console.error("âŒ Error loading customers:",a),console.error("âŒ Error details:",a.data),console.error("âŒ Error message:",a.message),a.message&&(a.message.includes("Invalid or expired token")||a.message.includes("Session expired"))){alert("Your session has expired. Please log in again."),N.logout(),window.location.href="/login";return}g([])}})()},[y]);const $=async t=>{if(t&&t.preventDefault&&t.preventDefault(),m({type:"",text:""}),d(!0),!s.firstName.trim()){m({type:"error",text:"Please enter a first name."}),d(!1);return}if(!s.lastName.trim()){m({type:"error",text:"Please enter a last name."}),d(!1);return}if(!s.email.trim()){m({type:"error",text:"Please enter an email address."}),d(!1);return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email.trim())){m({type:"error",text:"Please enter a valid email address."}),d(!1);return}if(!s.password||s.password.length<8){m({type:"error",text:"Please enter a password (min 8 characters)."}),d(!1);return}const l={firstName:s.firstName.trim(),lastName:s.lastName.trim(),email:s.email.trim(),phone:(s.phone||"").trim()||null,company:(s.companyName||"").trim()||null,address:`${s.address}, ${s.city}, ${s.state} ${s.zipCode}`.trim().replace(/^,\s*|,\s*$/g,"")||null,password:s.password};try{const r=await u.create(l);i({companyName:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",projectType:"",notes:"",password:""}),h(!1);const n=await u.getAll(),o=Array.isArray(n)?n:n.customers||[];g(o),m({type:"success",text:"Customer added successfully!"}),d(!1)}catch(r){let n="Failed to add customer. ";r.message.includes("Validation failed")?n+="Please check all required fields are filled correctly. Make sure you have entered both first and last name, a valid email address, and a password.":r.message.includes("already exists")?n+="A customer with this email already exists.":n+=`Error: ${r.message}`,m({type:"error",text:n}),d(!1)}},L=async t=>{if(t.preventDefault(),console.log("Attempting to update customer with data:",s),!s.firstName.trim()){alert("Please enter a first name.");return}if(!s.lastName.trim()){alert("Please enter a last name.");return}if(!s.email.trim()){alert("Please enter an email address.");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email.trim())){alert("Please enter a valid email address.");return}const l={firstName:s.firstName.trim(),lastName:s.lastName.trim(),email:s.email.trim(),phone:s.phone.trim()||null,company:s.companyName.trim()||null,address:`${s.address}, ${s.city}, ${s.state} ${s.zipCode}`.trim().replace(/^,\s*|,\s*$/g,"")||null,role:s.role,clientType:s.clientType,notes:s.notes};s.password&&s.password.length>=8&&(l.password=s.password);try{console.log("Sending updated customer data to backend:",l),await u.update(p,l),i({companyName:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",clientType:"",notes:""}),x(null),h(!1);const r=await u.getAll(),n=Array.isArray(r)?r:r.customers||[];g(n),alert("Customer updated successfully!")}catch(r){console.error("Error updating customer:",r),console.error("Error details:",r.data);let n="Failed to update customer. ";if(r.message.includes("Authentication required")){n+="Please log in again.",window.location.href="/login";return}else if(r.message.includes("Session expired")){n+="Your session has expired. Please log in again.",window.location.href="/login";return}else n+=`Error: ${r.message}`,r.data&&r.data.error&&r.data.error.details&&(n+=`

Validation errors:`,r.data.error.details.forEach(o=>{n+=`
- ${o.path||o.param}: ${o.msg}`}));alert(n)}},k=t=>{console.log("Editing customer:",t);let a="",l="",r="",n="";if(t.address){const o=t.address.split(", ");if(o.length>=1&&(a=o[0]||""),o.length>=2&&(l=o[1]||""),o.length>=3){const b=o[2].split(" ");r=b[0]||"",n=b[1]||""}}i({companyName:t.company||"",firstName:t.firstName||"",lastName:t.lastName||"",email:t.email||"",phone:t.phone||"",address:a,city:l,state:r,zipCode:n,clientType:t.clientType||"",notes:t.notes||"",role:t.role||"user"}),x(t.id),h(!0)},R=async t=>{if(window.confirm("Are you sure you want to delete this customer?"))try{await u.delete(t);const a=await u.getAll(),l=Array.isArray(a)?a:a.customers||[];g(l),alert("Customer deleted successfully!")}catch(a){console.error("Error deleting customer:",a);let l="Failed to delete customer. ";if(a.message.includes("Authentication required")){l+="Please log in again.",window.location.href="/login";return}else if(a.message.includes("Session expired")){l+="Your session has expired. Please log in again.",window.location.href="/login";return}else l+=`Error: ${a.message}`;alert(l)}};return P?e.jsx("div",{className:"crm-container",style:{minHeight:"60vh",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("h2",{children:"Loading CRM..."})}):y?e.jsxs("div",{className:"crm-container",children:[e.jsxs("div",{className:"crm-header",children:[e.jsx("h1",{className:"crm-title",children:"Customer Relationship Management"}),e.jsx("button",{className:"crm-logout-btn",onClick:()=>{N.logout(),v(!1),window.location.href="/"},children:"Logout"})]}),e.jsxs("div",{className:"crm-dashboard",children:[e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Customer Database"}),e.jsx("p",{children:"View and manage customer information, contact details, and project history."}),e.jsx("button",{className:"crm-btn-main",onClick:()=>{A(!f),h(!1),x(null)},children:f?"Hide Customers":"View Customers"}),e.jsx("button",{className:"crm-btn-secondary",onClick:()=>{h(!0),A(!1),x(null),i({companyName:"",firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",projectType:"",notes:""})},children:"Add Customer"})]}),e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Active Projects"}),e.jsxs("ul",{style:{listStyle:"none",padding:0},children:[e.jsx("li",{children:"Office Building Wiring - 75% Complete"}),e.jsx("li",{children:"Factory Automation - 40% Complete"}),e.jsx("li",{children:"Warehouse Network - Planning Phase"})]})]}),e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Recent Activity"}),e.jsxs("ul",{style:{listStyle:"none",padding:0},children:[e.jsx("li",{children:"New quote sent to ABC Corp"}),e.jsx("li",{children:"Project milestone reached"}),e.jsx("li",{children:"Customer feedback received"})]})]})]}),(w||f)&&e.jsxs("div",{className:"crm-section",children:[e.jsx("h2",{style:{color:"#22314a",marginBottom:"1.5rem"},children:"ðŸ‘¥ Customer Management"}),w&&e.jsxs("div",{className:"crm-form",children:[e.jsx("h3",{style:{color:"#22314a",marginBottom:"1rem"},children:p?"Edit Customer":"Add New Customer"}),e.jsxs("form",{onSubmit:p?L:$,noValidate:!0,children:[e.jsx("input",{type:"text",placeholder:"Company Name",value:s.companyName,onChange:t=>i({...s,companyName:t.target.value})}),e.jsx("input",{type:"text",placeholder:"First Name",value:s.firstName,onChange:t=>i({...s,firstName:t.target.value}),required:!0}),e.jsx("input",{type:"text",placeholder:"Last Name",value:s.lastName,onChange:t=>i({...s,lastName:t.target.value}),required:!0}),e.jsx("input",{type:"email",placeholder:"Email Address",value:s.email,onChange:t=>i({...s,email:t.target.value}),required:!0}),p&&e.jsxs("select",{value:s.role,onChange:t=>i({...s,role:t.target.value}),children:[e.jsx("option",{value:"user",children:"User"}),e.jsx("option",{value:"admin",children:"Admin"})]}),e.jsx("input",{type:"password",placeholder:p?"Set/Change Password (min 8 chars, optional)":"Password (min 8 chars)",value:s.password,onChange:t=>i({...s,password:t.target.value})}),e.jsx("input",{type:"tel",placeholder:"Phone Number",value:s.phone,onChange:t=>i({...s,phone:t.target.value})}),e.jsx("input",{type:"text",placeholder:"Street Address",value:s.address,onChange:t=>i({...s,address:t.target.value})}),e.jsx("input",{type:"text",placeholder:"City",value:s.city,onChange:t=>i({...s,city:t.target.value})}),e.jsx("input",{type:"text",placeholder:"State",value:s.state,onChange:t=>i({...s,state:t.target.value})}),e.jsx("input",{type:"text",placeholder:"ZIP Code",value:s.zipCode,onChange:t=>i({...s,zipCode:t.target.value})}),e.jsxs("select",{value:s.clientType,onChange:t=>i({...s,clientType:t.target.value}),children:[e.jsx("option",{value:"",children:"Select Client Type"}),e.jsx("option",{value:"Commercial",children:"Commercial"}),e.jsx("option",{value:"High End",children:"High End"}),e.jsx("option",{value:"Low End",children:"Low End"}),e.jsx("option",{value:"Residential",children:"Residential"}),e.jsx("option",{value:"Prospective",children:"Prospective"})]}),e.jsx("textarea",{placeholder:"Notes (optional)",value:s.notes,onChange:t=>i({...s,notes:t.target.value})}),C.text&&e.jsx("div",{className:`crm-feedback ${C.type}`,children:C.text}),e.jsxs("div",{className:"crm-form-actions",children:[e.jsx("button",{className:"crm-btn-main",type:"submit",disabled:E,children:p?"Update Customer":"Add Customer"}),e.jsx("button",{className:"crm-btn-secondary",type:"button",onClick:()=>{h(!1),x(null)},children:"Cancel"})]})]})]}),f&&e.jsxs("div",{children:[e.jsxs("h3",{style:{color:"#22314a",marginBottom:"1rem"},children:["Customer Database (",j.length," customers)"]}),e.jsx("div",{className:"crm-customer-list",children:j.length===0?e.jsx("div",{className:"crm-card",style:{textAlign:"center",color:"#666"},children:e.jsx("p",{children:'No customers added yet. Click "Add Customer" to get started.'})}):j.map(t=>e.jsxs("div",{className:"crm-customer-card",children:[e.jsxs("h4",{children:[t.firstName," ",t.lastName]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Company:"})," ",t.company]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",e.jsx("a",{href:`mailto:${t.email}`,style:{color:"#007bff",textDecoration:"none",marginLeft:"0.5rem"},children:t.email})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Phone:"})," ",e.jsx("a",{href:`tel:${t.phone}`,style:{color:"#007bff",textDecoration:"none",marginLeft:"0.5rem"},children:t.phone})]}),t.address&&e.jsxs("div",{children:[e.jsx("strong",{children:"Address:"})," ",t.address]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#666",marginTop:"1rem"},children:["Added: ",new Date(t.createdAt).toLocaleDateString()]}),e.jsxs("div",{className:"crm-customer-actions",children:[e.jsx("button",{className:"crm-btn-edit",onClick:()=>k(t),children:"Edit"}),e.jsx("button",{className:"crm-btn-delete",onClick:()=>R(t.id),children:"Delete"})]})]},t.id))})]})]})]}):e.jsx("div",{className:"crm-container",children:e.jsxs("div",{className:"crm-card",style:{maxWidth:500,margin:"3rem auto",textAlign:"center"},children:[e.jsx("h1",{className:"crm-title",children:"ðŸ”’ CRM Access Required"}),e.jsx("p",{style:{color:"#666",marginBottom:24},children:"Please log in to access the CRM system."}),e.jsx("a",{href:"/login",className:"crm-btn-main",children:"Go to Login Page"})]})})};export{T as default};
