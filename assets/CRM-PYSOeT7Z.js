import{j as e,a as f,c as h}from"./index-Bi7a7Wfs.js";import{b as d}from"./vendor-DR4o8xae.js";const F=()=>{const[v,w]=d.useState(!1),[E,P]=d.useState(!0),[N,x]=d.useState([]),[b,p]=d.useState(!1),[j,S]=d.useState(!1),[C,y]=d.useState(null),[k,m]=d.useState(!1),[A,u]=d.useState({type:"",text:""}),[s,l]=d.useState({companyName:"",contactName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",projectType:"",notes:""});d.useEffect(()=>{(()=>{const o=f.isAuthenticated();w(o),P(!1)})()},[]),d.useEffect(()=>{v&&(async()=>{try{const o=await h.getAll(),r=Array.isArray(o)?o:o.customers||[];x(r)}catch(o){console.error("Error loading customers:",o),x([])}})()},[v]);const $=async t=>{if(t&&t.preventDefault&&t.preventDefault(),console.log("=== HANDLE ADD CUSTOMER CALLED ==="),console.log("Event:",t),console.log("Form data:",s),console.log("Authentication status:",f.isAuthenticated()),console.log("Current user:",f.getCurrentUser()),console.log("Local Storage Token:",localStorage.getItem("authToken")),u({type:"",text:""}),m(!0),!s.contactName.trim()){u({type:"error",text:"Please enter a contact name."}),m(!1);return}if(!s.email.trim()){u({type:"error",text:"Please enter an email address."}),m(!1);return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email.trim())){u({type:"error",text:"Please enter a valid email address."}),m(!1);return}const r=s.contactName.trim().split(" "),c=r[0]||"Customer",g=r.slice(1).join(" ")||"User",i={firstName:c,lastName:g,email:s.email.trim(),phone:(s.phone||"").trim()||null,company:(s.companyName||"").trim()||null,address:`${s.address}, ${s.city}, ${s.state} ${s.zipCode}`.trim().replace(/^,\s*|,\s*$/g,"")||null};try{console.log("Sending customer data to backend:",i),console.log("Before API call - waiting for response...");const a=await h.create(i);console.log("Customer created successfully - API response received:",a),l({companyName:"",contactName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",projectType:"",notes:""}),p(!1);const n=await h.getAll(),T=Array.isArray(n)?n:n.customers||[];x(T),u({type:"success",text:"Customer added successfully!"}),m(!1)}catch(a){console.error("Detailed error adding customer:",a),console.error("Error message:",a.message),console.error("Error stack:",a.stack),console.error("Full error object:",JSON.stringify(a,null,2));let n="Failed to add customer. ";if(a.message.includes("Authentication required")){n+="Please log in again.",u({type:"error",text:n}),m(!1),setTimeout(()=>{window.location.href="/login"},500);return}else if(a.message.includes("Session expired")){n+="Your session has expired. Please log in again.",u({type:"error",text:n}),m(!1),setTimeout(()=>{window.location.href="/login"},500);return}else a.message.includes("Failed to fetch")||a.message.includes("NetworkError")?n+="Network error - backend server may not be running. Please check if the backend is started.":a.message.includes("Validation failed")?n+="Please check all required fields are filled correctly. Make sure you have entered both first and last name, and a valid email address.":a.message.includes("already exists")?n+="A customer with this email already exists.":n+=`Error: ${a.message}`;console.log("=== CUSTOMER CREATION ERROR DEBUG ==="),console.log("Customer data being sent:",i),console.log("Error type:",typeof a),console.log("Error constructor:",a.constructor.name),console.log("Is network error:",a.message.includes("Failed to fetch")),console.log("Current auth status:",f.isAuthenticated()),console.log("====================================="),u({type:"error",text:n}),m(!1)}},D=async t=>{if(t.preventDefault(),console.log("Attempting to update customer with data:",s),!s.contactName.trim()){alert("Please enter a contact name.");return}if(!s.email.trim()){alert("Please enter an email address.");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email.trim())){alert("Please enter a valid email address.");return}try{const r=s.contactName.trim().split(" "),c=r[0]||"Customer",g=r.slice(1).join(" ")||"User",i={firstName:c,lastName:g,email:s.email.trim(),phone:s.phone.trim()||null,company:s.companyName.trim()||null,address:`${s.address}, ${s.city}, ${s.state} ${s.zipCode}`.trim().replace(/^,\s*|,\s*$/g,"")||null};console.log("Sending updated customer data to backend:",i),await h.update(C,i),l({companyName:"",contactName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",projectType:"",notes:""}),y(null),p(!1);const a=await h.getAll(),n=Array.isArray(a)?a:a.customers||[];x(n),alert("Customer updated successfully!")}catch(r){console.error("Error updating customer:",r);let c="Failed to update customer. ";if(r.message.includes("Authentication required")){c+="Please log in again.",window.location.href="/login";return}else if(r.message.includes("Session expired")){c+="Your session has expired. Please log in again.",window.location.href="/login";return}else c+=`Error: ${r.message}`;alert(c)}},R=t=>{console.log("Editing customer:",t);let o="",r="",c="",g="";if(t.address){const i=t.address.split(", ");if(i.length>=1&&(o=i[0]||""),i.length>=2&&(r=i[1]||""),i.length>=3){const a=i[2].split(" ");c=a[0]||"",g=a[1]||""}}l({companyName:t.company||"",contactName:`${t.firstName||""} ${t.lastName||""}`.trim(),email:t.email||"",phone:t.phone||"",address:o,city:r,state:c,zipCode:g,projectType:t.projectType||"",notes:t.notes||""}),y(t.id),p(!0)},L=async t=>{if(window.confirm("Are you sure you want to delete this customer?"))try{await h.delete(t);const o=await h.getAll(),r=Array.isArray(o)?o:o.customers||[];x(r),alert("Customer deleted successfully!")}catch(o){console.error("Error deleting customer:",o);let r="Failed to delete customer. ";if(o.message.includes("Authentication required")){r+="Please log in again.",window.location.href="/login";return}else if(o.message.includes("Session expired")){r+="Your session has expired. Please log in again.",window.location.href="/login";return}else r+=`Error: ${o.message}`;alert(r)}};return E?e.jsx("div",{className:"crm-container",style:{minHeight:"60vh",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("h2",{children:"Loading CRM..."})}):v?e.jsxs("div",{className:"crm-container",children:[e.jsxs("div",{className:"crm-header",children:[e.jsx("h1",{className:"crm-title",children:"Customer Relationship Management"}),e.jsx("button",{className:"crm-logout-btn",onClick:()=>{f.logout(),w(!1),window.location.href="/"},children:"Logout"})]}),e.jsxs("div",{className:"crm-dashboard",children:[e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Customer Database"}),e.jsx("p",{children:"View and manage customer information, contact details, and project history."}),e.jsx("button",{className:"crm-btn-main",onClick:()=>{S(!j),p(!1),y(null)},children:j?"Hide Customers":"View Customers"}),e.jsx("button",{className:"crm-btn-secondary",onClick:()=>{p(!0),S(!1),y(null),l({companyName:"",contactName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",projectType:"",notes:""})},children:"Add Customer"})]}),e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Active Projects"}),e.jsxs("ul",{style:{listStyle:"none",padding:0},children:[e.jsx("li",{children:"Office Building Wiring - 75% Complete"}),e.jsx("li",{children:"Factory Automation - 40% Complete"}),e.jsx("li",{children:"Warehouse Network - Planning Phase"})]})]}),e.jsxs("div",{className:"crm-card",children:[e.jsx("h3",{children:"Recent Activity"}),e.jsxs("ul",{style:{listStyle:"none",padding:0},children:[e.jsx("li",{children:"New quote sent to ABC Corp"}),e.jsx("li",{children:"Project milestone reached"}),e.jsx("li",{children:"Customer feedback received"})]})]})]}),(b||j)&&e.jsxs("div",{className:"crm-section",children:[e.jsx("h2",{style:{color:"#22314a",marginBottom:"1.5rem"},children:"ðŸ‘¥ Customer Management"}),b&&e.jsxs("div",{className:"crm-form",children:[e.jsx("h3",{style:{color:"#22314a",marginBottom:"1rem"},children:C?"Edit Customer":"Add New Customer"}),e.jsxs("form",{onSubmit:C?D:$,noValidate:!0,children:[e.jsx("input",{type:"text",placeholder:"Company Name",value:s.companyName,onChange:t=>l({...s,companyName:t.target.value})}),e.jsx("input",{type:"text",placeholder:"Contact Name",value:s.contactName,onChange:t=>l({...s,contactName:t.target.value}),required:!0}),e.jsx("input",{type:"email",placeholder:"Email Address",value:s.email,onChange:t=>l({...s,email:t.target.value}),required:!0}),e.jsx("input",{type:"tel",placeholder:"Phone Number",value:s.phone,onChange:t=>l({...s,phone:t.target.value})}),e.jsx("input",{type:"text",placeholder:"Street Address",value:s.address,onChange:t=>l({...s,address:t.target.value})}),e.jsx("input",{type:"text",placeholder:"City",value:s.city,onChange:t=>l({...s,city:t.target.value})}),e.jsx("input",{type:"text",placeholder:"State",value:s.state,onChange:t=>l({...s,state:t.target.value})}),e.jsx("input",{type:"text",placeholder:"ZIP Code",value:s.zipCode,onChange:t=>l({...s,zipCode:t.target.value})}),e.jsxs("select",{value:s.projectType,onChange:t=>l({...s,projectType:t.target.value}),children:[e.jsx("option",{value:"",children:"Select Project Type"}),e.jsx("option",{value:"Network Infrastructure",children:"Network Infrastructure"}),e.jsx("option",{value:"Cable Installation",children:"Cable Installation"}),e.jsx("option",{value:"Equipment Setup",children:"Equipment Setup"}),e.jsx("option",{value:"Maintenance",children:"Maintenance"}),e.jsx("option",{value:"Consultation",children:"Consultation"}),e.jsx("option",{value:"System Integration",children:"System Integration"}),e.jsx("option",{value:"Upgrade",children:"Upgrade"}),e.jsx("option",{value:"Emergency Service",children:"Emergency Service"})]}),e.jsx("textarea",{placeholder:"Notes (optional)",value:s.notes,onChange:t=>l({...s,notes:t.target.value})}),A.text&&e.jsx("div",{className:`crm-feedback ${A.type}`,children:A.text}),e.jsxs("div",{className:"crm-form-actions",children:[e.jsx("button",{className:"crm-btn-main",type:"submit",disabled:k,children:C?"Update Customer":"Add Customer"}),e.jsx("button",{className:"crm-btn-secondary",type:"button",onClick:()=>{p(!1),y(null)},children:"Cancel"})]})]})]}),j&&e.jsxs("div",{children:[e.jsxs("h3",{style:{color:"#22314a",marginBottom:"1rem"},children:["Customer Database (",N.length," customers)"]}),e.jsx("div",{className:"crm-customer-list",children:N.length===0?e.jsx("div",{className:"crm-card",style:{textAlign:"center",color:"#666"},children:e.jsx("p",{children:'No customers added yet. Click "Add Customer" to get started.'})}):N.map(t=>e.jsxs("div",{className:"crm-customer-card",children:[e.jsxs("h4",{children:[t.firstName," ",t.lastName]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Company:"})," ",t.company]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",e.jsx("a",{href:`mailto:${t.email}`,style:{color:"#007bff",textDecoration:"none",marginLeft:"0.5rem"},children:t.email})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Phone:"})," ",e.jsx("a",{href:`tel:${t.phone}`,style:{color:"#007bff",textDecoration:"none",marginLeft:"0.5rem"},children:t.phone})]}),t.address&&e.jsxs("div",{children:[e.jsx("strong",{children:"Address:"})," ",t.address]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#666",marginTop:"1rem"},children:["Added: ",new Date(t.createdAt).toLocaleDateString()]}),e.jsxs("div",{className:"crm-customer-actions",children:[e.jsx("button",{className:"crm-btn-edit",onClick:()=>R(t),children:"Edit"}),e.jsx("button",{className:"crm-btn-delete",onClick:()=>L(t.id),children:"Delete"})]})]},t.id))})]})]})]}):e.jsx("div",{className:"crm-container",children:e.jsxs("div",{className:"crm-card",style:{maxWidth:500,margin:"3rem auto",textAlign:"center"},children:[e.jsx("h1",{className:"crm-title",children:"ðŸ”’ CRM Access Required"}),e.jsx("p",{style:{color:"#666",marginBottom:24},children:"Please log in to access the CRM system."}),e.jsx("a",{href:"/login",className:"crm-btn-main",children:"Go to Login Page"})]})})};export{F as default};
