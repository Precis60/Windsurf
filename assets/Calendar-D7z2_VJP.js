import{j as t,a as j,b as g,c as x,d as ue}from"./index-BvzUL563.js";import{b as c}from"./vendor-DPLMwiL-.js";import{A as J,a as pe}from"./AddressAutocomplete-C68TFOY8.js";const he=({open:u,title:C,message:w,onConfirm:E,onCancel:I})=>u?t.jsx("div",{className:"custom-modal-overlay",children:t.jsxs("div",{className:"custom-modal",children:[t.jsx("h3",{className:"custom-modal-title",children:C}),t.jsx("div",{className:"custom-modal-message",children:w}),t.jsxs("div",{className:"custom-modal-actions",children:[t.jsx("button",{className:"custom-modal-btn confirm",onClick:E,children:"Yes, Delete"}),t.jsx("button",{className:"custom-modal-btn cancel",onClick:I,children:"Cancel"})]})]})}):null,Z={"Personal Calendar":{color:"#F8C8DC",textColor:"#22314a"},"Business Calendar":{color:"#CDEAC0",textColor:"#22314a"},"Kids Sports & Events":{color:"#FDE2A7",textColor:"#22314a"},"Personal Sports & Events":{color:"#FFCFD2",textColor:"#22314a"},"Centre Com Computers":{color:"#D7C0FD",textColor:"#22314a"},Commerical:{color:"#C7D2FE",textColor:"#22314a"},"Daniel Allison":{color:"#BDE0FE",textColor:"#22314a"},"Jaki Lew":{color:"#CAF0F8",textColor:"#22314a"},"Krongold Family":{color:"#B8E0D2",textColor:"#22314a"},"Krongold Group":{color:"#FFE5B4",textColor:"#22314a"},"Office & Administration":{color:"#E3F2C1",textColor:"#22314a"},"Peter & Alla Lew":{color:"#F9E2AF",textColor:"#22314a"},"Remote Programming":{color:"#E4C1F9",textColor:"#22314a"},Residential:{color:"#F1F0FF",textColor:"#22314a"},"Rosie Lew":{color:"#FFD6E0",textColor:"#22314a"},"Stevie Lew":{color:"#FFEDC2",textColor:"#22314a"},"Supply & Demand":{color:"#D0F4DE",textColor:"#22314a"},"Training & Research":{color:"#C9E4DE",textColor:"#22314a"},"Travel Time":{color:"#EAD7BB",textColor:"#22314a"},"Website & Marketing":{color:"#E0E0E0",textColor:"#22314a"},"Precision Home Education":{color:"#CFE1F2",textColor:"#22314a"}},W=u=>Z[u]||{color:"#E0E0E0",textColor:"#000"},fe=()=>{const u="Australia/Sydney",[C,w]=c.useState(!1),[E,I]=c.useState(!0),[h,$]=c.useState("monthly"),[Q,f]=c.useState([]),[X,B]=c.useState([]),[L,b]=c.useState(null),[P,N]=c.useState(!1),[v,S]=c.useState(null),[d,_]=c.useState(new Date),[T,y]=c.useState([]),[ee,F]=c.useState(!1),[r,p]=c.useState({title:"",date:"",time:"",endTime:"",client:"",customerId:"",description:"",category:"",address:"",addressMeta:null}),[H,q]=c.useState(""),[te,k]=c.useState(!1),V=X.filter(e=>`${e.firstName} ${e.lastName}`.toLowerCase().includes(H.toLowerCase()));c.useEffect(()=>{(()=>{const a=j.isAuthenticated();w(a),I(!1)})()},[]);const A=e=>{if(!e.appointmentDate)return e;const a=new Date(e.appointmentDate),s=new Intl.DateTimeFormat("en-CA",{timeZone:u,year:"numeric",month:"2-digit",day:"2-digit"}).format(a),i=new Intl.DateTimeFormat("en-AU",{timeZone:u,hour:"2-digit",minute:"2-digit",hour12:!1}).format(a);let o=i;if(e.durationMinutes){const n=new Date(a.getTime()+e.durationMinutes*6e4);o=new Intl.DateTimeFormat("en-AU",{timeZone:u,hour:"2-digit",minute:"2-digit",hour12:!1}).format(n)}return{...e,time:i,endTime:o,date:s,appointmentDate:e.appointmentDate}};c.useEffect(()=>{C&&(async()=>{b(null);try{const a=await x.getAll(),i=(Array.isArray(a)?a:a.appointments||[]).map(A);f(i)}catch(a){console.error("Error loading appointments:",a),f([]);const s=a?.status===401?"Your session has expired. Please log in again to view appointments.":a?.message||"Failed to load appointments.";b({type:"error",message:s})}try{const a=await ue.getCalendarCustomers(),s=Array.isArray(a)?a:a.customers||[];B(s)}catch(a){console.error("Error loading customers:",a),B([]),a?.status===403?b({type:"error",message:"You are logged in without admin/staff permissions. Customer list is hidden. Appointments can still be created by typing a client name, but dropdown requires admin/staff."}):a?.status===401&&b({type:"error",message:"Your session has expired. Please log in again to load customers."})}try{const a=j.getCurrentUser?.();if(a&&(a.role==="admin"||a.role==="staff")){F(!0);const s=await g.getAll("?status=pending"),i=Array.isArray(s)?s:s.requests||[];y(i)}else y([])}catch(a){console.error("Error loading pending requests:",a),y([])}finally{F(!1)}})()},[C]),c.useEffect(()=>{const e=j.getCurrentUser?.();if(!(e&&(e.role==="admin"||e.role==="staff")))return;const a=setInterval(async()=>{try{const s=await g.getAll("?status=pending"),i=Array.isArray(s)?s:s.requests||[];y(i)}catch{}},6e4);return()=>clearInterval(a)},[]);const ae=async e=>{e.preventDefault(),console.log("Attempting to create appointment with data:",r);const a=Y(r.time,r.endTime);if(isNaN(a)||a<15||a>480){alert("Duration must be between 15 and 480 minutes.");return}if(!r.customerId||isNaN(Number(r.customerId))||!Number.isInteger(Number(r.customerId))){alert("Please select a valid client from the dropdown.");return}const s=`${r.date}T${r.time}:00`,i=new Date(s),o={title:r.title,description:r.description||`Client: ${r.client}
Category: ${r.category}
Address: ${r.address}`,appointmentDate:i.toISOString(),durationMinutes:a,customerId:Number(r.customerId),address:r.address||"",addressPlaceId:r.addressMeta?.placeId||null,addressLat:r.addressMeta?.lat??null,addressLng:r.addressMeta?.lng??null,addressComponents:r.addressMeta?.components||null};console.log("Appointment payload:",o),Object.keys(o).forEach(n=>{console.log(`${n}:`,o[n],"type:",typeof o[n])});try{const n=await x.create(o);console.log("Appointment created successfully:",n),p({title:"",date:"",time:"",endTime:"",client:"",customerId:"",description:"",category:"",address:"",addressMeta:null}),N(!1);const l=await x.getAll(),D=(Array.isArray(l)?l:l.appointments||[]).map(A);f(D),alert("Appointment added successfully!")}catch(n){let l="Failed to add appointment. ";n.response&&n.response.data&&n.response.data.error?(typeof n.response.data.error=="string"?l+=n.response.data.error:n.response.data.error.message?l+=n.response.data.error.message:l+=JSON.stringify(n.response.data.error),n.response.data.error.details&&(l+=`
Details:`,n.response.data.error.details.forEach(m=>{l+=`
- ${m.path}: ${m.msg} (value: ${m.value})`}))):n.message&&(l+=n.message),alert(l)}},Y=(e,a)=>{const[s,i]=e.split(":").map(Number),[o,n]=a.split(":").map(Number),l=s*60+i;return o*60+n-l},U=e=>{const a=se(e);S(e.id),p(a),q(a.client||""),N(!0)},ne=async e=>{e.preventDefault();const a=`${r.date}T${r.time}:00`,s=new Date(a),i=Y(r.time,r.endTime),o={title:r.title,description:r.description,appointmentDate:s.toISOString(),durationMinutes:i,customerId:Number(r.customerId),address:r.address||"",category:r.category||""};r.addressMeta&&(o.addressPlaceId=r.addressMeta.placeId||null,o.addressLat=r.addressMeta.lat??null,o.addressLng=r.addressMeta.lng??null,o.addressComponents=r.addressMeta.components||null);try{await x.update(v,o),p({title:"",date:"",time:"",endTime:"",client:"",description:"",category:"",address:"",addressMeta:null}),S(null),N(!1);const n=await x.getAll(),m=(Array.isArray(n)?n:n.appointments||[]).map(A);f(m)}catch(n){console.error("Error updating appointment:",n),alert("Failed to update appointment. Please try again.")}},[K,R]=c.useState({open:!1,id:null}),se=e=>{const a=e.client||(e.customer?`${e.customer.firstName||""} ${e.customer.lastName||""}`.trim():"")||"";return{title:e.title||"",date:e.date||"",time:e.time||"",endTime:e.endTime||"",client:a,customerId:e.customerId||e.customer?.id||"",description:e.description||"",category:e.category||"",address:e.address||"",addressMeta:null,id:e.id,appointmentDate:e.appointmentDate}},re=async e=>{R({open:!0,id:e})},oe=async()=>{const e=K.id;R({open:!1,id:null});try{await x.delete(e);const a=await x.getAll(),i=(Array.isArray(a)?a:a.appointments||[]).map(A);f(i)}catch(a){console.error("Error deleting appointment:",a),alert("Failed to delete appointment. Please try again.")}},O=e=>{const a=new Intl.DateTimeFormat("en-CA",{timeZone:u,year:"numeric",month:"2-digit",day:"2-digit"}).format(e);return Q.filter(s=>s.date===a)},ie=()=>{const e=Number(new Intl.DateTimeFormat("en-US",{timeZone:u,year:"numeric"}).format(d)),a=Number(new Intl.DateTimeFormat("en-US",{timeZone:u,month:"numeric"}).format(d))-1,s=new Date(e,a,1),i=s.getDay();let o=new Date(s);o.setDate(o.getDate()-i);const n=[];for(let l=0;l<42;l++){const m=new Date(o);m.setDate(o.getDate()+l),n.push(m)}return n},le=()=>{const e=d.getDay(),a=new Date(d);a.setDate(d.getDate()-e);const s=[];for(let i=0;i<7;i++){const o=new Date(a);o.setDate(a.getDate()+i),s.push(o)}return s},z=e=>{const a=new Date(d);switch(h){case"monthly":a.setMonth(d.getMonth()+e);break;case"weekly":a.setDate(d.getDate()+e*7);break;case"daily":a.setDate(d.getDate()+e);break}_(a)},M=()=>{const e=[];for(let a=0;a<24;a++)for(let s=0;s<60;s+=15){const i=`${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;e.push(i)}return e};return E?t.jsx("div",{className:"calendar-container",style:{minHeight:"60vh",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx("h2",{children:"Loading Calendar..."})}):C?t.jsxs("div",{className:"calendar-container",children:[t.jsxs("div",{className:"calendar-header",children:[t.jsx("h1",{className:"calendar-title",children:"Calendar Management"}),t.jsx("button",{className:"calendar-logout-btn",onClick:()=>{j.logout(),w(!1),window.location.href="/"},children:"Logout"})]}),L&&t.jsx("div",{className:`calendar-feedback ${L.type==="error"?"error":""}`,children:L.message}),t.jsxs("div",{className:"calendar-dashboard",children:[(()=>{const e=j.getCurrentUser?.();return e&&(e.role==="admin"||e.role==="staff")?t.jsxs("div",{className:"calendar-card",style:{width:"100%"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("h3",{children:"Pending Appointment Requests"}),t.jsx("button",{className:"calendar-btn-secondary",type:"button",onClick:async()=>{try{F(!0);const a=await g.getAll("?status=pending"),s=Array.isArray(a)?a:a.requests||[];y(s)}finally{F(!1)}},children:"Refresh"})]}),ee?t.jsx("div",{style:{color:"#666"},children:"Loading..."}):T.length===0?t.jsx("div",{style:{color:"#666"},children:"No pending requests."}):t.jsxs("div",{style:{display:"grid",gap:8},children:[T.slice(0,5).map(a=>t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderTop:"1px solid #eee"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:a.title}),t.jsxs("div",{style:{fontSize:12,color:"#666"},children:[new Date(a.requestedDate).toLocaleString("en-AU"),a.address?` • ${a.address}`:""]})]}),t.jsxs("div",{style:{display:"flex",gap:6},children:[t.jsx("button",{className:"calendar-btn-secondary",type:"button",onClick:async()=>{try{await g.update(a.id,{status:"approved",createAppointment:!0});const s=await g.getAll("?status=pending"),i=Array.isArray(s)?s:s.requests||[];y(i);const o=await x.getAll(),n=Array.isArray(o)?o:o.appointments||[];f(n.map(A))}catch{alert("Failed to approve.")}},children:"Approve & Create"}),t.jsx("button",{className:"calendar-btn-secondary",type:"button",onClick:async()=>{try{await g.update(a.id,{status:"approved",createAppointment:!1});const s=await g.getAll("?status=pending"),i=Array.isArray(s)?s:s.requests||[];y(i)}catch{alert("Failed to approve.")}},children:"Approve Only"}),t.jsx("button",{className:"calendar-btn-secondary",type:"button",onClick:async()=>{try{await g.update(a.id,{status:"declined"});const s=await g.getAll("?status=pending"),i=Array.isArray(s)?s:s.requests||[];y(i)}catch{alert("Failed to decline.")}},children:"Decline"})]})]},a.id)),T.length>5&&t.jsxs("div",{style:{fontSize:12,color:"#666"},children:["+ ",T.length-5," more pending..."]})]})]}):null})(),t.jsxs("div",{className:"calendar-card",children:[t.jsx("h3",{children:"Appointment Management"}),t.jsx("p",{children:"View and manage appointments, clients, and schedules."}),t.jsx("button",{className:"calendar-btn-main",onClick:()=>{N(!P),S(null),p({title:"",date:"",time:"",endTime:"",client:"",description:"",category:"",address:"",addressMeta:null})},children:P?"Cancel":"Add New Appointment"})]})]}),P&&t.jsxs("div",{className:"calendar-section",children:[t.jsx("h2",{style:{color:"#22314a",marginBottom:"1.5rem"},children:v?"Edit Appointment":"Add New Appointment"}),t.jsxs("form",{className:"calendar-form",onSubmit:e=>{if(e.preventDefault(),!r.customerId){alert("Please select a valid client from the dropdown.");return}(v?ne:ae)(e)},noValidate:!0,children:[t.jsx("input",{type:"text",placeholder:"Appointment Title",value:r.title,onChange:e=>p({...r,title:e.target.value}),required:!0,className:"calendar-input"}),t.jsxs("div",{className:"calendar-client-select",children:[t.jsx("input",{type:"text",placeholder:"Select Client",value:H||r.client,onChange:e=>{q(e.target.value),k(!0),p({...r,client:e.target.value})},onBlur:()=>{setTimeout(()=>k(!1),200)},onFocus:()=>k(!0),autoComplete:"off",required:!0,className:"calendar-input"}),te&&V.length>0&&t.jsx("div",{className:"calendar-client-dropdown",children:V.map(e=>t.jsxs("div",{className:"calendar-client-option",onClick:()=>{p({...r,client:`${e.firstName} ${e.lastName}`,customerId:e.id}),q(`${e.firstName} ${e.lastName}`),k(!1)},children:[e.firstName," ",e.lastName," ",e.company?`(${e.company})`:""]},e.id))})]}),t.jsx("input",{type:"date",value:r.date,onChange:e=>p({...r,date:e.target.value}),required:!0,className:"calendar-input"}),t.jsx(J,{label:"Start Time",value:r.time,onChange:e=>p({...r,time:e})}),t.jsx(J,{label:"End Time",value:r.endTime,onChange:e=>p({...r,endTime:e})}),t.jsxs("select",{value:r.category,onChange:e=>p({...r,category:e.target.value}),required:!0,className:"calendar-select",children:[t.jsx("option",{value:"",children:"Select a Category"}),Object.keys(Z).map(e=>t.jsx("option",{value:e,children:e},e))]}),t.jsx(pe,{label:"Address/Location",value:r.address,onChange:(e,a)=>{p({...r,address:e,addressMeta:a})},placeholder:"Start typing an Australian address…",showTip:!1}),t.jsx("textarea",{placeholder:"Description",value:r.description,onChange:e=>p({...r,description:e.target.value}),className:"calendar-textarea"}),t.jsxs("div",{className:"calendar-form-actions",children:[t.jsx("button",{className:"calendar-btn-main",type:"submit",children:v?"Update Appointment":"Add Appointment"}),t.jsx("button",{className:"calendar-btn-secondary",type:"button",onClick:()=>{N(!1),S(null)},children:"Cancel"}),v&&t.jsx("button",{className:"calendar-btn-delete",type:"button",onClick:()=>re(v),children:"Delete"})]})]})]}),t.jsxs("div",{className:"calendar-section",children:[t.jsxs("div",{className:"calendar-nav-header",children:[t.jsx("button",{onClick:()=>z(-1),className:"calendar-nav-btn",children:"‹ Previous"}),t.jsxs("h3",{className:"calendar-nav-title",children:[h==="monthly"&&new Intl.DateTimeFormat("en-AU",{timeZone:u,month:"long",year:"numeric"}).format(d),h==="weekly"&&`Week of ${new Intl.DateTimeFormat("en-AU",{timeZone:u,month:"short",day:"numeric",year:"numeric"}).format(d)}`,h==="daily"&&new Intl.DateTimeFormat("en-AU",{timeZone:u,weekday:"long",month:"long",day:"numeric",year:"numeric"}).format(d)]}),t.jsx("button",{onClick:()=>z(1),className:"calendar-nav-btn",children:"Next ›"}),t.jsxs("div",{className:"calendar-view-switcher",children:[t.jsx("button",{className:`calendar-view-btn${h==="monthly"?" active":""}`,onClick:()=>$("monthly"),type:"button",children:"Monthly"}),t.jsx("button",{className:`calendar-view-btn${h==="weekly"?" active":""}`,onClick:()=>$("weekly"),type:"button",children:"Weekly"}),t.jsx("button",{className:`calendar-view-btn${h==="daily"?" active":""}`,onClick:()=>$("daily"),type:"button",children:"Daily"})]})]}),h==="monthly"&&t.jsx("div",{className:"calendar-monthly-grid",children:ie().map((e,a)=>{const s=O(e),i=e.getMonth()===d.getMonth(),o=e.toDateString()===new Date().toDateString();return t.jsxs("div",{className:`calendar-day ${i?"":"calendar-day-muted"} ${o?"calendar-day-today":""}`,children:[t.jsx("div",{className:"calendar-day-date",children:e.getDate()}),s.filter(n=>{const l=n.time&&n.endTime&&String(n.time).trim()&&String(n.endTime).trim();return console.log("Appointment filter check:",n.id,"hasTime:",l,"time:",n.time,"endTime:",n.endTime),l}).map(n=>{const l=W(n.category);return t.jsxs("div",{className:"calendar-appointment",style:{backgroundColor:l.color,color:l.textColor},onClick:()=>{U(n)},children:[t.jsxs("div",{className:"calendar-appointment-time",children:[n.time," - ",n.endTime]}),t.jsx("div",{className:"calendar-appointment-title",children:n.title})]},n.id)})]},a)})}),h==="weekly"&&t.jsxs("div",{className:"calendar-weekly-grid",children:[t.jsxs("div",{className:"calendar-time-slots",children:[t.jsx("div",{className:"calendar-time-slot-header"}),M().map((e,a)=>t.jsx("div",{className:"calendar-time-slot",children:a%4===0?e:""},e))]}),t.jsx("div",{className:"calendar-days-grid",children:le().map((e,a)=>{const s=O(e),i=e.toDateString()===new Date().toDateString();return t.jsxs("div",{className:`calendar-day ${i?"calendar-day-today":""}`,children:[t.jsx("div",{className:"calendar-day-header",children:e.toLocaleDateString("en-US",{weekday:"short",month:"numeric",day:"numeric"})}),t.jsxs("div",{className:"calendar-day-body",children:[M().map((o,n)=>t.jsx("div",{className:"calendar-time-slot"},o)),s.filter(o=>{const n=o.time&&o.endTime&&String(o.time).trim()&&String(o.endTime).trim();return console.log("Weekly view appointment filter:",o.id,"hasTime:",n,"time:",o.time,"endTime:",o.endTime),n}).map(o=>{const n=W(o.category),[l,m]=o.time.split(":").map(Number),[D,ce]=o.endTime.split(":").map(Number),G=l*60+m,de=D*60+ce,me=Math.max(30,de-G);return t.jsxs("div",{className:"calendar-appointment",style:{top:`${G}px`,height:`${me}px`,backgroundColor:n.color,color:n.textColor},onClick:()=>{U(o)},children:[t.jsxs("div",{className:"calendar-appointment-time",children:[o.time," - ",o.endTime]}),t.jsx("div",{className:"calendar-appointment-title",children:o.title})]},o.id)})]})]},a)})})]}),h==="daily"&&t.jsxs("div",{className:"calendar-daily-grid",children:[t.jsxs("div",{className:"calendar-time-slots",children:[t.jsx("div",{className:"calendar-time-slot-header"}),M().map((e,a)=>t.jsx("div",{className:"calendar-time-slot",children:a%4===0?e:""},e))]}),t.jsxs("div",{className:"calendar-single-day",children:[t.jsx("div",{className:"calendar-day-header",children:d.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})}),t.jsxs("div",{className:"calendar-day-body",children:[M().map((e,a)=>t.jsx("div",{className:"calendar-time-slot"},e)),O(d).filter(e=>{const a=e.time&&e.endTime&&String(e.time).trim()&&String(e.endTime).trim();return console.log("Daily view appointment filter:",e.id,"hasTime:",a,"time:",e.time,"endTime:",e.endTime),a}).map(e=>{const a=W(e.category),[s,i]=e.time.split(":").map(Number),[o,n]=e.endTime.split(":").map(Number),l=s*60+i,m=o*60+n,D=Math.max(30,m-l);return t.jsxs("div",{className:"calendar-appointment",style:{top:`${l}px`,height:`${D}px`,backgroundColor:a.color,color:a.textColor},onClick:()=>{U(e)},children:[t.jsxs("div",{className:"calendar-appointment-time",children:[e.time," - ",e.endTime]}),t.jsx("div",{className:"calendar-appointment-title",children:e.title}),t.jsx("div",{className:"calendar-appointment-category",children:e.category})]},e.id)})]})]})]})]}),t.jsx(he,{open:K.open,title:"Delete Appointment",message:"Are you sure you want to delete this appointment? This action cannot be undone.",onConfirm:oe,onCancel:()=>R({open:!1,id:null})})]}):t.jsx("div",{className:"calendar-container",children:t.jsxs("div",{className:"calendar-card",style:{maxWidth:500,margin:"3rem auto",textAlign:"center"},children:[t.jsx("h1",{className:"calendar-title",children:"🔒 Calendar Access Required"}),t.jsx("p",{style:{color:"#666",marginBottom:24},children:"Please log in to access the calendar system."}),t.jsx("a",{href:"/login",className:"calendar-btn-main",children:"Go to Login Page"})]})})};export{fe as default};
